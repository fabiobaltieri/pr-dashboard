<!DOCTYPE html>

<!--
  Copyright 2024 Google LLC
  Copyright (c) 2024, The Linux Foundation
  SPDX-License-Identifier: Apache-2.0
-->

<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous" />

    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/2.1.8/css/dataTables.bootstrap5.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,700;1,400&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      rel="stylesheet" />
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/2.1.8/js/dataTables.jqueryui.min.js"></script>

    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/responsive/3.0.3/js/dataTables.responsive.min.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/responsive/3.0.3/css/responsive.dataTables.min.css" />

    <style>
      a {
        text-decoration: none;
        color: var(--body-text-color);
      }

      a:hover {
        color: var(--body-text-color);
        text-decoration: underline;
      }

      #gh-username-input {
        width: 200px;
        padding: 10px 15px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        transition: border-color 0.3s, box-shadow 0.3s;
        outline: none;
      }

      #gh-username-input:focus {
        border-color: #333f67;
        box-shadow: 0px 0px 8px rgba(51, 63, 103, 0.5);
      }

      #gh-username-input::placeholder {
        color: #aaa;
        font-style: italic;
      }

      a.approved {
        font-weight: 500;
        color: var(--bs-form-valid-color);
      }

      a.blocked {
        font-weight: 500;
        color: var(--bs-form-invalid-color);
      }

      .ellipsis {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .narrow {
        max-width: 150px;
      }

      .wide {
        max-width: 400px;
      }

      .prs tr.draft {
        font-style: italic;
        opacity: 0.5;
      }

      .prs {
        caption-side: inherit;
      }

      .prs caption {
        font-size: 1.2rem;
        font-weight: bold;
        padding-top: 0em;
      }

      .dt-container + .dt-container {
        margin-top: 2em;
      }

      .dt-search {
        position: absolute;
        right: 2em;
        font-size: smaller;
      }
    </style>

    <script type="text/javascript">
      (() => {
        const getPreferredTheme = () => {
          return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        };

        const setTheme = (theme) => {
          document.documentElement.setAttribute("data-bs-theme", theme);
        };

        setTheme(getPreferredTheme());
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
          setTheme(getPreferredTheme());
        });
      })();

      prs = null;

      function saveGHUser(name) {
        localStorage.setItem("gh_user", name);
      }

      function loadGHUser() {
        return localStorage.getItem("gh_user");
      }

      function populateAutocomplete(users) {
        const datalist = document.getElementById("usernames");
        Object.keys(users)
          .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()))
          .forEach((username) => {
            const option = document.createElement("option");
            option.value = username;
            datalist.appendChild(option);
          });
      }

      function timeSince(timestamp) {
        const then = moment(timestamp);
        return then.fromNow();
      }

      function approvedCount(count) {
        linkClass = count ? "approved" : "none";
        return `<span class="${linkClass}">${count}</span>`;
      }

      function blockedCount(count) {
        linkClass = count ? "blocked" : "none";
        return `<span class="${linkClass}">${count}</span>`;
      }

      function prLink(repo, pr, text) {
        return `<a href="https://github.com/zephyrproject-rtos/${repo}/pull/${pr}">${text}</a>`;
      }

      function userLink(user) {
        linkClass = "";
        if (user.startsWith("+")) {
          linkClass = "approved";
          user = user.substring(1);
        }
        if (user.startsWith("-")) {
          linkClass = "blocked";
          user = user.substring(1);
        }

        return `<a class="${linkClass}" href="https://github.com/${user}">${user}</a>`;
      }

      function sortUsernames(a, b) {
        const getPriority = (str) => (str.startsWith("-") ? -2 : str.startsWith("+") ? -1 : 0);
        const priorityA = getPriority(a);
        const priorityB = getPriority(b);
        return priorityA === priorityB ? a.localeCompare(b) : priorityA - priorityB;
      }

      function createDataTable(id, caption) {
        new DataTable($(`#${id}`), {
          columns: [
            { title: "#", responsivePriority: 100 },
            { title: "Title", className: "ellipsis wide", responsivePriority: 2 },
            {
              title: "Author",
              render: (data, type, row) => (type == "display" ? userLink(data) : data),
              responsivePriority: 3,
            },
            {
              title: "Assignee",
              render: (data, type, row) =>
                type == "display" ? data.sort(sortUsernames).map(userLink).join(", ") : data,
              responsivePriority: 4,
            },
            {
              title: "Reviewers",
              render: (data, type, row) =>
                type == "display" ? data.sort(sortUsernames).map(userLink).join(", ") : data,
              className: "ellipsis narrow",
              responsivePriority: 5,
            },
            { title: "Base", responsivePriority: 200 },
            {
              title: "Updated",
              render: (data, type, row) => (type == "display" ? timeSince(data) : data),
              responsivePriority: 6,
            },
            { title: "Status", visible: false },
          ],
          order: [[6, "desc"]], // Show most recently updated PRs first
          paging: false,
          info: false,
          responsive: {
            details: false,
          },
          stateSave: true,
          createdRow: function (row, data, index) {
            if (data[7] === "draft") {
              $(row).addClass("draft");
            }
          },
        }).caption(caption);
      }

      function appendData(values, tableId) {
        const dataTable = $(`#${tableId}`).DataTable();

        for (const key of values.sort().reverse()) {
          const prData = prs[key];
          const repo = key.split("/")[0];
          const pr = key.split("/")[1];

          const row = [
            prLink(repo, pr, "#" + pr),
            prData ? prLink(repo, pr, prData.title) : "-- missing PR data --",
            prData ? prData.author : "",
            prData ? prData.assignee_names : [],
            prData ? prData.reviewer_names : [],
            prData ? `${repo}/${prData.base}` : "",
            prData ? prData.updated_at : "",
            prData ? (prData.draft ? "draft" : "open") : "",
          ];

          dataTable.row.add(row);
        }
        dataTable.columns.adjust().draw().responsive.recalc();
        oldCaption = dataTable.caption().split(" (")[0];
        dataTable.caption(oldCaption + ` (${dataTable.rows().count()})`);
      }

      function appendUser(values) {
        appendData(values.author, "author");
        appendData(values.blocking, "blocking");
        appendData(values.assignee, "assignee");
        appendData(values.reviewer, "reviewer");
        appendData(values.approved, "approved");
        appendData(values.commented, "commented");

        // find all unassigned zephyr PRs needing attention
        const unassigned = Object.keys(prs).filter((key) => {
          const prData = prs[key];
          const repo = key.split("/")[0];
          const pr = key.split("/")[1];
          if (repo !== "zephyr") {
            return false;
          }
          return prData.assignee_names.length === 0 && !prData.draft;
        });
        appendData(unassigned, "unassigned");

        // find all zephyr PRs were only the assignee has approved (and no one else) and where no
        // one as blocked
        const onlyAssigneeApproved = Object.keys(prs).filter((key) => {
          const prData = prs[key];
          const repo = key.split("/")[0];
          const pr = key.split("/")[1];
          if (repo !== "zephyr") {
            return false;
          }
          return prData.assignee_approved === 1 && prData.blocked === 0 && prData.approved === 0;
        });
        appendData(onlyAssigneeApproved, "only_assignee_approved");
      }

      function processData(data) {
        prs = data[0];
        const users = data[1];
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get("username");

        if (username && users[username]) {
          appendUser(users[username]);
        }
        populateAutocomplete(users);
      }

      window.addEventListener("load", () => {
        const tableConfigs = [
          { id: "author", caption: "Authored" },
          { id: "blocking", caption: "Blocked" },
          { id: "assignee", caption: "Assigned" },
          { id: "reviewer", caption: "Reviewer" },
          { id: "approved", caption: "Approved" },
          { id: "commented", caption: "Commented" },
          { id: "unassigned", caption: "Unassigned [zephyr repo only]" },
          { id: "only_assignee_approved", caption: "Only Assignee Approved [zephyr repo only]" },
        ];

        tableConfigs.forEach((config) => {
          createDataTable(config.id, config.caption);
        });

        const ghUsernameInput = document.getElementById("gh-username-input");
        ghUsernameInput.value = new URLSearchParams(window.location.search).get("username") || loadGHUser();
        history.replaceState(null, "", `?username=${ghUsernameInput.value}`);

        // ENTER key pressed
        ghUsernameInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            const username = ghUsernameInput.value.trim();
            saveGHUser(username);
            window.location.href = `?username=${username}`;
          }
        });

        // autocomplete entry selection
        ghUsernameInput.addEventListener("change", () => {
          const username = ghUsernameInput.value.trim();
          saveGHUser(username);
          window.location.href = `?username=${username}`;
        });

        const urls = ["prs.json", "users.json"];
        Promise.all(urls.map((url) => fetch(url).then((res) => res.json()))).then((res) =>
          processData(res)
        );

      });
    </script>
  </head>

  <body>
    <nav id="navbar" class="navbar bg-body-tertiary px-3 mb-3 sticky-top">
      <div class="container-fluid">
        <form class="d-flex">
          <input
            class="form-controls"
            id="gh-username-input"
            type="text"
            placeholder="Enter GitHub username"
            list="usernames" />
          <datalist id="usernames"></datalist>
        </form>
        <ul class="nav nav-pills">
          <li class="nav-item">
            <a class="nav-link" href="#author">Authored</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#blocking">Blocked</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#assignee">Assigned</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#reviewer">Reviewer</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#approved">Approved</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#commented">Commented</a>
          </li>
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              data-bs-toggle="dropdown"
              href="#"
              role="button"
              aria-expanded="false"
              >More…</a
            >
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#unassigned">Unassigned</a></li>
              <li>
                <a class="dropdown-item" href="#only_assignee_approved">Only Assignee Approved</a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>

    <div
      data-bs-spy="scroll"
      data-bs-target="#navbar"
      data-bs-smooth-scroll="true"
      data-bs-root-margin="0px 0px -60%"
      data-bs-threshold="0,0.1"
      class="bg-body-tertiary p-3 rounded-2">
      <table id="author" class="table table-sm table-striped table-hover prs display"></table>
      <table id="blocking" class="table table-sm table-striped table-hover prs display"></table>
      <table id="assignee" class="table table-sm table-striped table-hover prs display"></table>
      <table id="reviewer" class="table table-sm table-striped table-hover prs display"></table>
      <table id="approved" class="table table-sm table-striped table-hover prs display"></table>
      <table id="commented" class="table table-sm table-striped table-hover prs display"></table>
      <!-- Additional tables for various types of PRs that need attention -->
      <table id="unassigned" class="table table-sm table-striped table-hover prs display"></table>
      <table
        id="only_assignee_approved"
        class="table table-sm table-striped table-hover prs display"></table>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"></script>
  </body>
</html>
